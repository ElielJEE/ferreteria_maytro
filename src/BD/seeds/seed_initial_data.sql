-- Seed: initial data for ferreteria_maytro
-- 1) rol administrador
-- 2) usuario admin
-- 3) 10 categorias
-- 4) 2 subcategorias por categoria
-- 5) 10 productos con subcategoria asignada

USE ferreteria_maytro;

-- Roles
INSERT INTO ROL (ROL_NAME)
SELECT 'ADMIN' FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM ROL WHERE ROL_NAME = 'ADMIN');

-- Crear rol VENDEDOR si no existe
INSERT INTO ROL (ROL_NAME)
SELECT 'VENDEDOR' FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM ROL WHERE ROL_NAME = 'VENDEDOR');

-- Obtener id del rol admin
SET @admin_role_id = (SELECT ID_ROL FROM ROL WHERE ROL_NAME = 'ADMIN' LIMIT 1);
SET @vendedor_role_id = (SELECT ID_ROL FROM ROL WHERE ROL_NAME = 'VENDEDOR' LIMIT 1);

-- Usuario administrador (si no existe)
INSERT INTO USUARIOS (NOMBRE, NOMBRE_USUARIO, CORREO, CONTRASENA, ESTATUS, ID_ROL)
SELECT 'Administrador', 'admin', 'admin@local', '$2b$12$pmU5.BK.qYmaixEb8vW06eeznqlmDR97FElNJsJ7btWWIG3PNwe4G', 'ACTIVO', @admin_role_id
FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin');

-- Usuario vendedor por defecto (si no existe), asignado a S1
-- La contraseña es el mismo hash del admin (Admin123!) por conveniencia de pruebas
INSERT INTO USUARIOS (NOMBRE, NOMBRE_USUARIO, CORREO, CONTRASENA, ESTATUS, ID_ROL, ID_SUCURSAL)
SELECT 'Vendedor Demo', 'vendedor1', 'vendedor1@local', '$2b$12$pmU5.BK.qYmaixEb8vW06eeznqlmDR97FElNJsJ7btWWIG3PNwe4G', 'ACTIVO', @vendedor_role_id, 'S1'
FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM USUARIOS WHERE NOMBRE_USUARIO = 'vendedor1');

-- Categorias (10)
INSERT INTO CATEGORIAS (ID_CATEGORIAS, NOMBRE_CATEGORIAS)
VALUES
('C01', 'Ferretería General'),
('C02', 'Electricidad'),
('C03', 'Plomería'),
('C04', 'Pinturas'),
('C05', 'Herramientas Manuales'),
('C06', 'Herramientas Eléctricas'),
('C07', 'Cementos y Adhesivos'),
('C08', 'Seguridad y Protección'),
('C09', 'Carpintería'),
('C10', 'Jardinería')
ON DUPLICATE KEY UPDATE NOMBRE_CATEGORIAS = VALUES(NOMBRE_CATEGORIAS);

-- Subcategorias: 2 por categoria
INSERT INTO SUBCATEGORIAS (ID_SUBCATEGORIAS, NOMBRE_SUBCATEGORIA, ID_CATEGORIAS)
VALUES
('SC01','Tornillería','C01'),
('SC02','Fijaciones','C01'),

('SC03','Cables','C02'),
('SC04','Conectores','C02'),

('SC05','Tubos','C03'),
('SC06','Accesorios Plomería','C03'),

('SC07','Esmaltes','C04'),
('SC08','Barnices','C04'),

('SC09','Martillos','C05'),
('SC10','Destornilladores','C05'),

('SC11','Taladros','C06'),
('SC12','Sierras','C06'),

('SC13','Cementos','C07'),
('SC14','Adhesivos','C07'),

('SC15','Cascos','C08'),
('SC16','Guantes','C08'),

('SC17','Clavos y Clavadoras','C09'),
('SC18','Lijas','C09'),

('SC19','Fertilizantes','C10'),
('SC20','Herramientas de Jardín','C10')
ON DUPLICATE KEY UPDATE NOMBRE_SUBCATEGORIA = VALUES(NOMBRE_SUBCATEGORIA), ID_CATEGORIAS = VALUES(ID_CATEGORIAS);

-- Productos (10) asignados a subcategorias
INSERT INTO PRODUCTOS (CODIGO_PRODUCTO, PRODUCT_NAME, CANTIDAD, ID_SUBCATEGORIAS)
VALUES
('HER001','Martillo de Carpintero 16oz','100','SC09'),
('HER002','Destornillador Phillips #2','150','SC10'),
('ELE001','Cable Eléctrico 12 AWG','200','SC03'),
('PLO001','Tubo PVC 3/4"','120','SC05'),
('PIN001','Esmalte Blanco 1L','80','SC07'),
('HER003','Taladro Percutor 500W','25','SC11'),
('CEM001','Cemento Portland 50kg','60','SC13'),
('SEG001','Casco de Seguridad','40','SC15'),
('CAR001','Clavos 3" x 1kg','300','SC17'),
('JAR001','Manguera Jardin 15m','50','SC20')
ON DUPLICATE KEY UPDATE PRODUCT_NAME = VALUES(PRODUCT_NAME), CANTIDAD = VALUES(CANTIDAD), ID_SUBCATEGORIAS = VALUES(ID_SUBCATEGORIAS);

-- Crear tabla unidades_medidas si no existe (tipos de unidad: Pzs, Mts, Lata, etc.)
CREATE TABLE IF NOT EXISTS UNIDADES_MEDIDAS (
	ID_UNIDAD INT AUTO_INCREMENT PRIMARY KEY,
	NOMBRE VARCHAR(100) NOT NULL,
	UNIQUE KEY uk_unidad_nombre (NOMBRE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Crear tabla producto_unidades si no existe (relación producto -> unidad con precio y cantidad por unidad)
CREATE TABLE IF NOT EXISTS PRODUCTO_UNIDADES (
	ID INT AUTO_INCREMENT PRIMARY KEY,
	PRODUCT_ID INT NOT NULL,
	UNIDAD_ID INT NOT NULL,
	PRECIO DECIMAL(12,2) NOT NULL DEFAULT 0.00,
	CANTIDAD_POR_UNIDAD DECIMAL(12,4) NOT NULL DEFAULT 1.0000,
	ES_POR_DEFECTO TINYINT(1) NOT NULL DEFAULT 0,
	INDEX idx_pu_product (PRODUCT_ID),
	INDEX idx_pu_unidad (UNIDAD_ID),
	CONSTRAINT fk_pu_prod FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTOS(ID_PRODUCT) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT fk_pu_unidad FOREIGN KEY (UNIDAD_ID) REFERENCES UNIDADES_MEDIDAS(ID_UNIDAD) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insertar unidades por defecto si no existen
INSERT INTO UNIDADES_MEDIDAS (NOMBRE)
SELECT 'Pzs' FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM UNIDADES_MEDIDAS WHERE NOMBRE = 'Pzs');
INSERT INTO UNIDADES_MEDIDAS (NOMBRE)
SELECT 'Mts' FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM UNIDADES_MEDIDAS WHERE NOMBRE = 'Mts');
INSERT INTO UNIDADES_MEDIDAS (NOMBRE)
SELECT 'Lata' FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM UNIDADES_MEDIDAS WHERE NOMBRE = 'Lata');

-- Asociar unidades a productos de ejemplo (si no existen)
-- Ejemplo: asignar Pzs con precio igual al PRECIO del producto y cantidad_por_unidad = 1
INSERT INTO PRODUCTO_UNIDADES (PRODUCT_ID, UNIDAD_ID, PRECIO, CANTIDAD_POR_UNIDAD, ES_POR_DEFECTO)
SELECT p.ID_PRODUCT, u.ID_UNIDAD, 0.00, 1.0000, 1
FROM PRODUCTOS p
JOIN UNIDADES_MEDIDAS u ON u.NOMBRE = 'Pzs'
WHERE NOT EXISTS (
	SELECT 1 FROM PRODUCTO_UNIDADES pu WHERE pu.PRODUCT_ID = p.ID_PRODUCT AND pu.UNIDAD_ID = u.ID_UNIDAD
);

-- Fin del seed

-- =============================
-- SEED: CONTROL DE STOCK
-- =============================

-- Sucursales base (idempotente)
INSERT INTO SUCURSAL (ID_SUCURSAL, NOMBRE_SUCURSAL, DIRECCION, TELEFONO)
VALUES
('S1', 'Sucursal Sur', 'Avenida Sur 123', '8888-0001'),
('S2', 'Sucursal Centro', 'Calle Central 456', '8888-0002')
ON DUPLICATE KEY UPDATE NOMBRE_SUCURSAL = VALUES(NOMBRE_SUCURSAL), DIRECCION = VALUES(DIRECCION), TELEFONO = VALUES(TELEFONO);

-- Stock por sucursal (idempotente)
INSERT INTO STOCK_SUCURSAL (ID_PRODUCT, ID_SUCURSAL, CANTIDAD, STATUS)
VALUES
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S1', 3, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S2', 10, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1), 'S1', 10, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'ELE001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'ELE001' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'PLO001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'PLO001' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'PIN001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'PIN001' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER003' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER003' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'CEM001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'CEM001' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'SEG001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'SEG001' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'CAR001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'CAR001' LIMIT 1), 'S2', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'JAR001' LIMIT 1), 'S1', 0, 'ACTIVO'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'JAR001' LIMIT 1), 'S2', 0, 'ACTIVO')
ON DUPLICATE KEY UPDATE CANTIDAD = VALUES(CANTIDAD), STATUS = VALUES(STATUS);

-- Rango mínimo/máximo (Nivelación) por producto y sucursal (idempotente)
INSERT INTO NIVELACION (ID_PRODUCT, ID_SUCURSAL, CANTIDAD, CANTIDAD_MAX)
VALUES
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S1', '5', '30'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1), 'S1', '5', '30'),
((SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S2', '10', '40')
ON DUPLICATE KEY UPDATE CANTIDAD = VALUES(CANTIDAD), CANTIDAD_MAX = VALUES(CANTIDAD_MAX);

-- Ejemplos de productos dañados (idempotente por combinación única definida manualmente)
-- HER001 en S1: 7 dañados
INSERT INTO STOCK_DANADOS (ID_PRODUCT, ID_SUCURSAL, CANTIDAD, TIPO_DANO, ESTADO, USUARIO_ID, PERDIDA, DESCRIPCION)
SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S1', 7, 'Golpe', 'reportado', (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 0.00, 'Cabeza dañada'
WHERE NOT EXISTS (
	SELECT 1 FROM STOCK_DANADOS sd
	WHERE sd.ID_PRODUCT = (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1)
		AND sd.ID_SUCURSAL = 'S1' AND sd.TIPO_DANO = 'Golpe'
);

-- HER002 en S1: 5 dañados
INSERT INTO STOCK_DANADOS (ID_PRODUCT, ID_SUCURSAL, CANTIDAD, TIPO_DANO, ESTADO, USUARIO_ID, PERDIDA, DESCRIPCION)
SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1), 'S1', 5, 'Oxidación', 'reportado', (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 0.00, 'Oxido leve'
WHERE NOT EXISTS (
	SELECT 1 FROM STOCK_DANADOS sd
	WHERE sd.ID_PRODUCT = (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1)
		AND sd.ID_SUCURSAL = 'S1' AND sd.TIPO_DANO = 'Oxidación'
);

	-- =============================
	-- RESERVAS (tabla y datos demo)
	-- =============================

	-- Crear tabla RESERVAS si no existe (alineado con API)
	CREATE TABLE IF NOT EXISTS RESERVAS (
		ID_RESERVA INT AUTO_INCREMENT PRIMARY KEY,
		ID_PRODUCT INT NOT NULL,
		ID_SUCURSAL VARCHAR(10) NOT NULL,
		ID_CLIENTES INT NULL,
		RESERVADO_POR INT NULL,
 		CANTIDAD DECIMAL(12,2) NOT NULL,
		FECHA_RESERVA DATE NOT NULL,
		FECHA_ENTREGA DATE NULL,
		ESTADO ENUM('pendiente','parcial','completada','cancelada') NOT NULL DEFAULT 'pendiente',
		TELEFONO_CONTACTO VARCHAR(20) NULL,
		NOTAS VARCHAR(255) NULL,
		CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
		UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		INDEX idx_res_prod (ID_PRODUCT),
		INDEX idx_res_suc (ID_SUCURSAL),
		INDEX idx_res_cli (ID_CLIENTES),
		INDEX idx_res_estado (ESTADO),
		CONSTRAINT fk_res_product  FOREIGN KEY (ID_PRODUCT) REFERENCES PRODUCTOS(ID_PRODUCT) ON DELETE RESTRICT ON UPDATE CASCADE,
		CONSTRAINT fk_res_sucursal FOREIGN KEY (ID_SUCURSAL) REFERENCES SUCURSAL(ID_SUCURSAL) ON DELETE RESTRICT ON UPDATE CASCADE,
		CONSTRAINT fk_res_cliente FOREIGN KEY (ID_CLIENTES) REFERENCES CLIENTES(ID_CLIENTES) ON DELETE SET NULL ON UPDATE CASCADE,
		CONSTRAINT fk_res_user     FOREIGN KEY (RESERVADO_POR) REFERENCES USUARIOS(ID) ON DELETE SET NULL ON UPDATE CASCADE
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

	-- Reservas de ejemplo (idempotentes)
	-- HER001 Centro: 10 reservados
	INSERT INTO RESERVAS (ID_PRODUCT, ID_SUCURSAL, ID_CLIENTES, RESERVADO_POR, CANTIDAD, FECHA_RESERVA, FECHA_ENTREGA, ESTADO, TELEFONO_CONTACTO, NOTAS)
	SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S2', NULL, (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 10, CURDATE(), NULL, 'pendiente', '8888-9999', 'Reserva demo HER001 S2'
	WHERE NOT EXISTS (
		SELECT 1 FROM RESERVAS r
		WHERE r.ID_PRODUCT = (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1)
			AND r.ID_SUCURSAL = 'S2' AND r.CANTIDAD = 10 AND r.ESTADO = 'pendiente'
	);

	-- HER002 Sur: 5 reservados
	INSERT INTO RESERVAS (ID_PRODUCT, ID_SUCURSAL, ID_CLIENTES, RESERVADO_POR, CANTIDAD, FECHA_RESERVA, FECHA_ENTREGA, ESTADO, TELEFONO_CONTACTO, NOTAS)
	SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1), 'S1', NULL, (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 5, CURDATE(), NULL, 'pendiente', '7777-6666', 'Reserva demo HER002 S1'
	WHERE NOT EXISTS (
		SELECT 1 FROM RESERVAS r
		WHERE r.ID_PRODUCT = (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1)
			AND r.ID_SUCURSAL = 'S1' AND r.CANTIDAD = 5 AND r.ESTADO = 'pendiente'
	);

	-- =============================
	-- MOVIMIENTOS_INVENTARIO demo (idempotentes via referencia_id)
	-- =============================

	-- Reservado HER001 en S2 (10)
	INSERT INTO MOVIMIENTOS_INVENTARIO (producto_id, sucursal_id, usuario_id, tipo_movimiento, cantidad, motivo, fecha, referencia_id, stock_anterior, stock_nuevo)
	SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S2', (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 'reservado', 10, 'Reserva inicial seed', NOW(), 'SEED-RES-HER001-S2', NULL, NULL
	WHERE NOT EXISTS (SELECT 1 FROM MOVIMIENTOS_INVENTARIO WHERE referencia_id = 'SEED-RES-HER001-S2');

	-- Reservado HER002 en S1 (5)
	INSERT INTO MOVIMIENTOS_INVENTARIO (producto_id, sucursal_id, usuario_id, tipo_movimiento, cantidad, motivo, fecha, referencia_id, stock_anterior, stock_nuevo)
	SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER002' LIMIT 1), 'S1', (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 'reservado', 5, 'Reserva inicial seed', NOW(), 'SEED-RES-HER002-S1', NULL, NULL
	WHERE NOT EXISTS (SELECT 1 FROM MOVIMIENTOS_INVENTARIO WHERE referencia_id = 'SEED-RES-HER002-S1');

	-- Entrada PLO001 en S1 (20)
	INSERT INTO MOVIMIENTOS_INVENTARIO (producto_id, sucursal_id, usuario_id, tipo_movimiento, cantidad, motivo, fecha, referencia_id, stock_anterior, stock_nuevo)
	SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'PLO001' LIMIT 1), 'S1', (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 'entrada', 20, 'Recepción inicial', NOW(), 'SEED-ENT-PLO001-S1', NULL, NULL
	WHERE NOT EXISTS (SELECT 1 FROM MOVIMIENTOS_INVENTARIO WHERE referencia_id = 'SEED-ENT-PLO001-S1');

	-- Salida HER001 en S1 (2)
	INSERT INTO MOVIMIENTOS_INVENTARIO (producto_id, sucursal_id, usuario_id, tipo_movimiento, cantidad, motivo, fecha, referencia_id, stock_anterior, stock_nuevo)
	SELECT (SELECT ID_PRODUCT FROM PRODUCTOS WHERE CODIGO_PRODUCTO = 'HER001' LIMIT 1), 'S1', (SELECT ID FROM USUARIOS WHERE NOMBRE_USUARIO = 'admin' LIMIT 1), 'salida', 2, 'Consumo demo', NOW(), 'SEED-SAL-HER001-S1', NULL, NULL
	WHERE NOT EXISTS (SELECT 1 FROM MOVIMIENTOS_INVENTARIO WHERE referencia_id = 'SEED-SAL-HER001-S1');
